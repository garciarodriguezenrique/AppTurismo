{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'venues/mapview.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'venues/slidestyle.css' %}">

<html>
  <head>
    <title>Tourism App - Show Results</title>
    
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>


    <div id="sidenav" class="sidenav">
      
    </div>



    <div id="map"></div>
    <script>
      var venues_json = '{{ venues }}';
      var user_location = '{{ user_location }}';
      var travel_mode = '{{ travel_mode }}'
      var j_loc = JSON.parse(user_location.replace(/&#39;/g,'"'));
      var user_position = {lat: j_loc["lat"], lng: j_loc["long"]};
      var j = JSON.parse(venues_json.replace(/&#39;/g,'"'));
      // new (pd) : venues_json.replace(/&#39;/g,'"').replace(/&quot;/g, "'").replace(/&lt;/g, "<").replace(/&gt;/g, ">")
      // old (json) : venues_json.replace(/&#39;/g,'"')
      var markers = [];
      var route = [];
      var map;
      var open_marker;
      var side_bar_html;
     

      function openPanel(){
            var panel = document.getElementsByClassName('js-cd-panel-main');
            console.log(panel);
            console.log("addClass");
            addClass(panel, 'cd-panel--is-visible');
            console.log("add close panel event listener");
            panel.addEventListener('click', function(event){
		if( hasClass(event.target, 'js-cd-close') || hasClass(event.target, panelClass)) {
			event.preventDefault();
			removeClass(panel, 'cd-panel--is-visible');
		}
	    });
            
        }

      function hideMarkersOutsideOfRoute(){
          for (e in markers){
              if (!Object.keys(route).includes(markers[e].getTitle())){
                  markers[e].setVisible(false);
              }
          }
      }

      function calculateRouteControl(controlDiv, map) {
        //Borde
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '50%';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
        controlDiv.appendChild(controlUI);

        //Interior
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = 'Calcular ruta';
        controlUI.appendChild(controlText);

        //Evento
        controlUI.addEventListener('click', function() {
          
          var destinations = [];
          for (venue in route){
              destinations.push(route[venue]);
	  }
          var service = new google.maps.DistanceMatrixService();
          service.getDistanceMatrix(
          {
              origins: [user_position],
              destinations: destinations,
              travelMode: travel_mode,
              unitSystem: google.maps.UnitSystem.METRIC,
              }, distanceMatrixCallback);
          });

      }

      function distanceMatrixCallback(response, status){
          if (status == 'OK') {
              var origins = response.originAddresses;
              var destinations = response.destinationAddresses;
              var max_distance = 0;
              var waypoints = [];
              var currentFarthestPoint;


              var results = response.rows[0].elements;
                  for (var j = 0; j < results.length; j++) {
                      var element = results[j];
                      var distance = element.distance.text.replace(",",".");
                      var duration = element.duration.text;
                      var from = origins[0];
                      var to = destinations[j];
                      
                      if (parseFloat(distance.split(" ")[0])>max_distance){
                      console.log("Which is greater than "+max_distance);
                          if (typeof(currentFarthestPoint)=="undefined"){
                              currentFarthestPoint = {address: to, dist: distance};
                              max_distance = parseFloat(distance.split(" ")[0]);
                          } else {
                              waypoints.push({
                                  location: currentFarthestPoint["address"],
                                  stopover: true
                              });
                              currentFarthestPoint = {address: to, dist: distance};
                              max_distance = parseFloat(distance.split(" ")[0]);
                          }
                      } else {
                           waypoints.push({
                               location: to,
                               stopover: true
                           });
                      }
                      //console.log(to+" - "+distance);
                  }
              }
              for (e in waypoints) {
                  console.log(waypoints[e]);
              }

              directionsService.route({
                  origin: user_position,
                  destination: currentFarthestPoint["address"],
                  waypoints: waypoints,
                  optimizeWaypoints: true,
                  travelMode: travel_mode
              }, function(response, status) {
                  if (status === 'OK') {
                      hideMarkersOutsideOfRoute();
                      directionsDisplay.setDirections(response);
                  } else {
                      window.alert('Directions request failed due to ' + status);
                  }
              });
          
      }

      function calculateAndDisplayRoute(destination_lat, destination_long) {

        //Oculta el resto de marcadores y cierra la ventana del seleccionado antes de mostrar la ruta
        for (e in markers) {
          if (markers[e].getTitle() !== open_marker.getTitle()){
            markers[e].setVisible(false);
          } else {
            markers[e].infoWindow.close()
          }
        }

        directionsService.route({
          origin: user_position,
          destination: {lat: destination_lat, lng: destination_long},
          travelMode: travel_mode,
        }, function(response, status) {
          if (status === 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }

      function addToRoute(name, lat, lng) {
        var checkBox = document.getElementById("check_"+name);
        if (checkBox.checked == true){
          console.log("true");
          route[name] = new google.maps.LatLng(lat, lng) //{"lat":lat, "lng":lng};
        } else {
          console.log("false");
          delete route[name];
        }
      }

      //Función para el evento click en los elementos del panel lateral. Si hay otra ventana abierta la cierra antes de mostrar la seleccionada.
      function myclick(i) {
	if (typeof open_marker !== 'undefined'){
            open_marker.infoWindow.close();
        }
        google.maps.event.trigger(markers[i], "click");
        open_marker = markers[i];
      }

      function placeMarkers(){
          Object.keys(j).forEach(function(venue) {

              venue_name = j[venue]['name']
              venue_coordinates = j[venue]['geometry']['location']
    
              contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+venue_name+'</h1>'+
                '<div id="bodyContent">'+
                '<p><b>'+venue_name+'</b></p>'+
                '<p>Attribution: '+venue_name+', <a href="https://www.google.es/#q='+venue_name+'">'+
                'Más información</a><BR>'+
                '<button onclick="calculateAndDisplayRoute('+ venue_coordinates["lat"] +','+ venue_coordinates["lng"] +')">Ir!</button>'+
                '</p>'+
                '</div>';

               var infowindow = new google.maps.InfoWindow({
                 content: contentString
               });

               var marker = new google.maps.Marker({
                 position : new google.maps.LatLng(venue_coordinates["lat"], venue_coordinates["lng"]),
                 map : map,
                 infoWindow: infowindow,
                 title: venue_name
               });

             
               google.maps.event.addListener(marker, 'click', function() {
                 if (typeof open_marker !== 'undefined'){
                   open_marker.infoWindow.close();
                 }
                 map.setCenter(this.position);
                 this.infoWindow.open(map, this);
                 open_marker = this;
               });
               
           
	       //Se añade el evento click a los elementos del panel lateral
               //href="javascript:myclick(' + (markers.length) + ')"
               
               side_bar_html += '<a href="javascript:myclick(' + (markers.length) + ')">'
               + venue_name + " | " 
               + (j[venue]['opening_hours']  !== 0 ?  j[venue]['opening_hours'] + " | " : "" )
               + (j[venue]['rating']  !== 0 ?  j[venue]['rating'] + " | " : "" )
               + '<input type="checkbox" id="check_'+venue_name+'" onclick="addToRoute('+"'"+venue_name+"'"+','+venue_coordinates["lat"]+','+venue_coordinates["lng"]+')"></a>'
               + " | "
               //Aquí iría el enlace para las vistas detalle con href

               markers.push(marker);
             });

      }


      function initMap() {
        directionsService = new google.maps.DirectionsService;
        directionsDisplay = new google.maps.DirectionsRenderer;

        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: j_loc["lat"], lng: j_loc["long"]},
          zoom: 15
        });

        directionsDisplay.setMap(map);
        var routeControlDiv = document.createElement('div');
        var routeControl = new calculateRouteControl(routeControlDiv, map);

        routeControlDiv.index = 1;
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(routeControlDiv);
        //Esto hace que Google Directions no coloque marcadores por defecto en los punto de inicio y origen de la ruta (para eso ya tenemos los nuestros)
        directionsDisplay.setOptions( { suppressMarkers: true } );

      /*Object.keys(j).forEach(function(key) {
         console.log(key +': '+ j[key]["lat"]+","+j[key]["long"]);
      });*/
      //var url = https://cdn0.iconfinder.com/data/icons/maps-locations-5/24/map_location_user_location-512.png

  
        //Marcador+icono para mostrar la ubicación del usuario     
        var icon = { 
           url: 'https://static.thenounproject.com/png/67172-200.png',
           scaledSize: new google.maps.Size(50, 50)
        };

        var user_marker = new google.maps.Marker({
           position: new google.maps.LatLng(j_loc["lat"], j_loc["long"]),
           map: map,
           title: 'Usted está aquí',
           icon: icon
        });
           
        
	//Se preparan y colocan los marcadores
        placeMarkers();
        document.getElementById("sidenav").innerHTML = side_bar_html;
       


      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEDOKsldYBl9NQ6Ml9uYVGOW2vosygeSs&callback=initMap"
    async defer></script>
  </body>
</html>
